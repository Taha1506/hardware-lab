## قالب پیام‌های استفاده شده در پروژه

پیام‌های تولید شده در ماژول
DWR در لایه ی فیزیکی از قابل زیر که توسط
IEEE
استانداردسازی شده است
تبعیت می‌کنند:

![image](https://github.com/user-attachments/assets/eee1d5e7-2735-4e1e-ada5-947d71807c73)

از آنجا که قصد شبیه‌سازی در لایه ی فیزیکی را نداریم، در این پروژه با Payload لایه ی MAC سروکار خواهیم داشت، که به فرم زیر است:
![image](https://github.com/user-attachments/assets/df97f1ec-9a70-4ec9-a981-7af96e18dda4)

### جزئیات Frameها

در ابتدای Frame، سرآیند لایه ی MAC قرار دارد که خود از بخش های زیر تشکیل شده است:

#### بخش Frame Control Field (FCF): این بخش خود شامل اطلاعات مختلفی است.
۱. ابتدا *نوع پیام* می‌آید که مشخص می‌کند کاربرد این پیام چیست
در الگوریتم TDoA دو نوع پیام داریم: یکی پیامی که Tag برای مشخص شدن موقعیت خودش به Anchor ها می‌فرستد و دیگری پیامی که یک Anchor اصلی
برای همگام سازی کلاک به Anchor های دیگر می‌فرستد.
۲. سپس *نوع آدرس‌دهی* می‌آید که معمولا آدرس‌دهی ۱۶ بیتی انتخاب می‌شود؛ به این معنا که هر Tag یا Anchor در شبکه ی UWB ی مورد نظر یک شناسه ی 
۱۶بیتی دارد که هنگام ارسال پیام به عنوان شناسه ‌ی فرستنده آن را می‌فرستد.
۳. فیلد بعدی مربوط به *حالت فشرده برای شناسه ی شبکه ی UWB* است. در صورتی که همه ی دستگاه ها در یک شبکه ی شخصی (PAN) قرار داشته باشند (که در شبیه‌سازی ما همینگونه است) می‌توان از این قابلیت استفاده کرد.
۴. فیلد بعدی مربوط به وجود یک فیلد امنیتی در پیام است، که در کاربرد ما می‌تواند غیرفعال باشد.
۵. در انتها هم یک فیلد برای درخواست Ack قرار دارد که مجددا می‌توانیم در کاربر خود آن را غیرفعال در نظر بگیریم.

#### بخش Sequence Number:
این بخش مانند sequence number در پروتوکل TCP عمل می‌کند. در هر پیامی که Tag ارسال می‌کند، مقدار این فیلد یکی زیاد می‌شود.

#### بخش آدرس دهی:
در این بخش شناسه ی فرستنده و گیرنده می‌آید که در هر دو نوع پیام ارسال شده (یعنی از طرف Tag و همچنین Anchor اصلی) می‌تواند 
گیرنده ی آن آدرس 0xFFFF باشد (که به معنای Broadcast کردن پیام به همه است). به طور دقیق‌تر، ترتیب آدرس‌ها به این شرح است:
الف. آدرس شبکه ی مقصد
ب. آدرس مقصد (که معمولا 0xFFFF است)
ج. آدرس شبکه ی مبدأ (که اگر فیلد *حالت فشرده برای شناسه ی شبکه ی UWB* فعال باشد از آن صرف‌نظر می‌شود)
د. آدرس مبدأ
#### بخش ‌Payload
که شامل محتوای اصلی پیام است. برای پیام ارسال شده از سوی Tag ها می‌تواند خالی باشد. برای پیام ارسالی از طرف Anchor
اصلی، شامل ۴۰ بیت می‌شود که کلاک Anchor اصلی در زمان ارسال پیام را مشخص می‌کند.
#### بخش FCS
این بخش به طور خودکار توسط DWR1000 گذاشته می‌شود و یک فیلد CRC به طول ۲ بایت است. در صورتی که پیامی با CRC اشتباه دریافت شود، DWR1000 می‌تواند آن را دور بیندازد.
می‌توانیم در این شبیه‌سازی وقوع خطا را با عوض شدن احتمالاتی برخی از بیت‌ها انجام دهیم.

پیام‌هایی که از طرف پردازشگرهای Anchor به سرور مرکزی ارسال می‌شوند بسته به طراح دارد. فعلا یک انتخاب قابل قبول، می‌تواند ارسال اطلاعات به صورت JSON از طریق WiFi باشد.


## جزئیات فرایند موقعیت‌یابی
شروع فرایند موقعیت‌یابی با Broadcast شدن یک پیام از سوی Tag آغاز می‌شود. بسامد انجام این کار قابل تنظیم است.  Anchor ها، دائما مشغول گوش دادن به محیط هستند و هر کدام بسته به فاصله‌ای که از Tag دارند، در زمان مشخصی پیام را دریافت می‌کنند.
سپس زمان دریافت را ثبت کرده، یک گزارش به سوی سرور مرکزی موقعیت‌یابی ارسال می‌کنند. برای انجام صحیح موقعیت‌یابی، لازم است که هر Anchor اختلاف کلاک خودش را
با Anchor اصلی بداند، که برای این کار از روشهای مختلفی استفاده می‌شود. یک راه ساده و کارآمد، رساندن سیگنال کلاک با سیم به همه ی Anchor ها است. در این شبیه‌سازی
از روش بی‌سیم استفاده می‌کنیم که در ادامه جزئیات بیشتری از آن آمده است.

## جزئیات فرایند همگام‌سازی
در این فرایند، فرض بر این است که ارسال و دریافت پیام توسط بخش آنالوگ ماژول‌ها مقدار معلوم و کالیبره‌شده‌ای دارد. همچنین مختصات هر Anchor از پیش تعیین شده و معلوم است.
شیوه ی کار به این صورت است که با یک بسامد مشخص، Anchor اصلی پیامی شامل زمان فعلی کلاک خودش می‌فرستد. این پیام بسته به فاصله‌ای که
این Anchor با Anchor های دیگر دارد، در زمانی به هر یک از آن‌ها می‌رسد. برای یک Anchor خاص، این زمان برابر با حاصل جمع زمان ارسال پیام، تأخیر بخش آنالوگ Anchor اصلی، تأخیر انتشار سیگنال در محیط، و تأخیر بخش آنالوگ
آن Anchor است. با توجه به فرض  های انجام شده، تمام تأخیر ها معلوم هستند و زمان ارسال پیام هم که در payload آن قرار دارد. بنابراین آن Anchor متوجه می‌شود که زمان فعلی در Anchor اصلی چقدر است، و با مقایسه ی آن با زمان خودش،
به میزان اختلاف زمانی بین خودش و آن پی‌می‌برد. در هنگام ارسال گزارش به سرور مرکزی، این اختلاف زمانی هم مورد استفاده قرار می‌گیرد.
